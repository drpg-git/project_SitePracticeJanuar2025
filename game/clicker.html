<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grinch RPG: Ultimate Collection</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');

        :root {
            --bg: #020617;
            --accent: #38bdf8;
            --grinch: #4ade80;
            --danger: #ef4444;
            --gold: #facc15;
            --purple: #a855f7;
            --card-bg: rgba(15, 23, 42, 0.85);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; cursor: none !important; }
        body {
            margin: 0; background: var(--bg); color: white;
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow: hidden; height: 100vh;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            text-decoration: none;
            color: white;
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            font-weight: 600;
            font-size: 14px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-link:hover {
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
            transform: translateX(5px);
        }

        /* --- SIDEBAR --- */
        .side-menu {
            position: fixed; left: 0; top: 50%; transform: translateY(-50%);
            background: var(--card-bg); border: 2px solid var(--accent);
            border-left: none; border-radius: 0 24px 24px 0; padding: 25px 15px;
            display: flex; flex-direction: column; gap: 15px; z-index: 4000;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5); backdrop-filter: blur(15px);
        }
        .side-menu-title { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); font-weight: 800; text-align: center; }
        .menu-item {
            color: white; text-decoration: none; font-size: 13px; font-weight: 700;
            padding: 12px 20px; border-radius: 12px; background: rgba(255,255,255,0.03);
            transition: 0.3s; text-align: center; border: 1px solid var(--glass-border);
        }
        .menu-item:hover { background: var(--accent); color: #000; transform: translateX(10px); }

        /* --- GAME STAGE --- */
        #main-stage {
            width: 100%; height: 100%; position: relative;
            background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }

        /* --- HUD --- */
        .hud-top {
            position: absolute; top: 40px; display: flex; gap: 40px;
            padding: 20px 40px; border-radius: 30px;
            background: var(--glass); border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px); z-index: 100;
        }
        .hud-stat { display: flex; flex-direction: column; align-items: center; min-width: 100px; }
        .hud-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); font-weight: 800; }
        .hud-value { font-size: 26px; font-weight: 800; text-shadow: 0 0 15px var(--accent); }

        /* --- BUTTONS --- */
        .rebirth-btn {
            position: absolute; top: 40px; right: 40px;
            padding: 15px 25px; border-radius: 15px; border: 1px solid var(--purple);
            background: rgba(168, 85, 247, 0.1); color: white; font-weight: 800;
            backdrop-filter: blur(10px); transition: 0.3s; z-index: 100; text-align: center;
        }
        .rebirth-btn:hover { background: var(--purple); transform: scale(1.05); }

        .btn-group {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; align-items: center; z-index: 100;
        }
        .btn-main {
            padding: 15px 40px; border-radius: 15px; border: 1px solid var(--accent);
            background: var(--card-bg); color: white; font-weight: 800;
            backdrop-filter: blur(10px); transition: 0.3s; width: 280px;
        }
        .btn-main:hover { background: var(--accent); color: #000; box-shadow: 0 0 30px var(--accent); }
        .btn-gallery { border-color: var(--gold); }
        .btn-gallery:hover { background: var(--gold); color: #000; }

        /* --- WORLD --- */
        #gift-container { position: relative; z-index: 10; }
        #gift {
            font-size: 180px; cursor: pointer; user-select: none;
            filter: drop-shadow(0 0 50px rgba(56, 189, 248, 0.3));
            transition: 0.1s;
        }
        .shake { animation: shake 0.2s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.9) rotate(2deg); } }

        .entity { position: absolute; font-size: 45px; pointer-events: none; z-index: 5; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        /* --- CARD MINIGAME --- */
        #card-overlay {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95);
            z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(20px);
        }
        .cards-container { display: flex; gap: 30px; margin-top: 50px; }
        .card {
            width: 200px; height: 300px; background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 2px solid var(--accent); border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 60px; transition: 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative; transform-style: preserve-3d;
        }
        .card:hover { transform: translateY(-20px) scale(1.05); box-shadow: 0 0 40px var(--accent); border-color: #fff; }
        .card.flipped { transform: rotateY(180deg); }
        .card.fail { transform: translateY(100vh) rotate(20deg); opacity: 0; border-color: var(--danger); }
        .card-front, .card-back {
            position: absolute; inset: 0; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center; border-radius: 18px;
        }
        .card-back { background: #fff; transform: rotateY(180deg); overflow: hidden; }
        .card-back img { width: 100%; height: 100%; object-fit: cover; }

        /* --- GALLERY --- */
        #gallery-overlay {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98);
            z-index: 5000; display: none; padding: 50px; overflow-y: auto;
        }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 30px; }
        .gallery-item { border: 1px solid var(--glass-border); border-radius: 15px; overflow: hidden; background: var(--glass); position: relative; }
        .gallery-item img { width: 100%; aspect-ratio: 1; object-fit: cover; }

        /* --- SKILL TREE --- */
        #tree-overlay {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98);
            z-index: 3000; display: none; padding: 40px; backdrop-filter: blur(40px); overflow-y: auto;
        }
        .tree-scroll-area { position: relative; min-height: 1400px; width: 1000px; margin: 0 auto; }
        .node {
            position: absolute; width: 80px; height: 80px; border-radius: 24px; background: var(--glass);
            border: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center;
            font-size: 28px; transition: 0.4s; z-index: 10;
        }
        .node.locked { opacity: 0.2; }
        .node.available { border-color: var(--accent); cursor: pointer; }
        .node.unlocked { border-color: var(--grinch); background: rgba(74, 222, 128, 0.1); }

        /* --- CANVAS --- */
        canvas { position: absolute; inset: 0; pointer-events: none; }
        #cursor { width: 10px; height: 10px; background: white; border-radius: 50%; position: fixed; pointer-events: none; z-index: 10000; transform: translate(-50%, -50%); box-shadow: 0 0 20px white; }
    </style>
</head>
<body>
<a href="/portfolio" class="back-link">
    <span>‚Üê</span> –ù–∞–∑–∞–¥ –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
</a>
<div id="cursor"></div>

<nav class="side-menu">
    <div class="side-menu-title">New Year Hub</div>
    <a href="/game/grinch" class="menu-item">üê≤ –ó–ú–ï–ô–ö–ê</a>
    <a href="/game/puzzles" class="menu-item">üß© –ü–ê–ó–õ–´</a>
    <a href="/game/ratatype" class="menu-item">‚å®Ô∏è –¢–†–ï–ù–ê–ñ–ï–†</a>
    <a href="/game/gd" class="menu-item">üü¶ GEODASH</a>
    <a href="/game/photo" class="menu-item">üì∏ PHOTOEDITOR</a>
    <a href="/game/dino" class="menu-item">ü¶ñ –î–ò–ù–û–ó–ê–í–†–ò–ö</a>
    <a href="/game/clicker" class="menu-item active">üíé –ö–õ–ò–ö–ï–†</a>
</nav>

<div id="main-stage">
    <canvas id="snow-canvas"></canvas>
    <canvas id="fx-canvas"></canvas>
    <canvas id="tracer-canvas"></canvas>
    
    <div id="entities-layer"></div>

    <div class="hud-top">
        <div class="hud-stat"><span class="hud-label">–ö—Ä–∏—Å—Ç–∞–ª–ª—ã</span><span class="hud-value" id="money-txt">0</span></div>
        <div class="hud-stat"><span class="hud-label">–£—Ä–æ–≤–µ–Ω—å</span><span class="hud-value" id="lvl-txt">1</span></div>
        <div class="hud-stat"><span class="hud-label">–ú–Ω–æ–∂–∏—Ç–µ–ª—å</span><span class="hud-value" style="color:var(--purple)" id="mult-txt">x1</span></div>
    </div>

    <button class="rebirth-btn" onclick="tryRebirth()">–ü–ï–†–ï–†–û–ñ–î–ï–ù–ò–ï<br><small id="rebirth-cost" style="color:var(--gold)">–ù—É–∂–Ω–æ: 1M</small></button>

    <div id="gift-container"><div id="gift">üéÅ</div></div>

    <div class="btn-group">
        <button class="btn-main" onclick="toggleTree(true)">–î–†–ï–í–û –ù–ê–í–´–ö–û–í</button>
        <button class="btn-main" onclick="startCardGame()">–ö–£–ü–ò–¢–¨ –ü–û–î–ê–†–û–ö (1 üíé)</button>
        <button class="btn-main btn-gallery" onclick="toggleGallery(true)">–ì–ê–õ–ï–†–ï–Ø –ü–û–î–ê–†–ö–û–í</button>
    </div>
</div>

<div id="card-overlay">
    <h1 style="font-size: 40px; margin: 0;">–í–´–ë–ï–†–ò –°–í–û–ô <span style="color:var(--accent)">–ü–û–î–ê–†–û–ö</span></h1>
    <div class="cards-container" id="cards-container"></div>
</div>

<div id="gallery-overlay">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 style="font-size: 40px; margin:0;">–í–ê–®–ê <span style="color:var(--gold)">–ö–û–õ–õ–ï–ö–¶–ò–Ø</span></h1>
        <button class="rebirth-btn" style="position:static" onclick="toggleGallery(false)">–ó–ê–ö–†–´–¢–¨</button>
    </div>
    <div class="gallery-grid" id="gallery-grid"></div>
</div>

<div id="tree-overlay">
    <div style="display:flex; justify-content:space-between; align-items:center; max-width:1000px; margin: 0 auto 50px;">
        <h1 style="font-size: 52px; margin:0;">SKILL <span style="color:var(--accent)">TREE</span></h1>
        <button class="rebirth-btn" style="position:static" onclick="toggleTree(false)">–ó–ê–ö–†–´–¢–¨</button>
    </div>
    <div class="tree-scroll-area" id="tree-area">
        <svg id="tree-lines" style="position:absolute; inset:0; width:100%; height:100%; pointer-events:none;"></svg>
    </div>
</div>

<script>
    const SKILLS = [
        { id: '1', x: 50, y: 92, icon: 'üß§', name: '–°–∏–ª–∞', cost: 100, req: null },
        { id: '2', x: 30, y: 80, icon: 'üßù', name: '–≠–ª—å—Ñ', cost: 500, req: '1', visual: 'üßù' },
        { id: '3', x: 70, y: 80, icon: 'üïØÔ∏è', name: '–°–≤–µ—Ç', cost: 1200, req: '1' },
        { id: '4', x: 20, y: 65, icon: 'ü¶å', name: '–û–ª–µ–Ω—å', cost: 4000, req: '2', visual: 'ü¶å' },
        { id: '6', x: 60, y: 65, icon: '‚ùÑÔ∏è', name: '–ú–æ—Ä–æ–∑', cost: 20000, req: '3' },
        { id: '14', x: 50, y: 5, icon: 'üíé', name: '–ê–±—Å–æ–ª—é—Ç', cost: 100000, req: '6' }
    ];

    let state = JSON.parse(localStorage.getItem('grinch_final_v4')) || {
        money: 0, exp: 0, lvl: 1, rebirths: 0, unlocked: [], gallery: []
    };

    const fxCanvas = document.getElementById('fx-canvas');
    const tracerCanvas = document.getElementById('tracer-canvas');
    const snowCanvas = document.getElementById('snow-canvas');
    const fctx = fxCanvas.getContext('2d');
    const tctx = tracerCanvas.getContext('2d');
    const sctx = snowCanvas.getContext('2d');

    let particles = [];
    let snowflakes = [];
    let tracerPoints = [];
    let entities = {};

    function resize() {
        fxCanvas.width = tracerCanvas.width = snowCanvas.width = window.innerWidth;
        fxCanvas.height = tracerCanvas.height = snowCanvas.height = window.innerHeight;
    }
    window.onresize = resize; resize();

    function save() { localStorage.setItem('grinch_final_v4', JSON.stringify(state)); }

    function getStats() {
        let s = { click: 1, auto: 0, mult: 1 + (state.rebirths * 5) };
        state.unlocked.forEach(id => {
            if(id==='1') s.click += 15; if(id==='2') s.auto += 30; if(id==='6') s.mult *= 2;
        });
        return s;
    }

    // --- SNOW ---
    for(let i=0; i<80; i++) snowflakes.push({ x: Math.random()*innerWidth, y: Math.random()*innerHeight, r: Math.random()*3+1, v: Math.random()*1+0.5 });

    // --- CLICK ---
    document.getElementById('gift').onmousedown = (e) => {
        const s = getStats();
        const gain = s.click * s.mult;
        state.money += gain; state.exp += gain;
        
        const g = document.getElementById('gift');
        g.classList.remove('shake'); void g.offsetWidth; g.classList.add('shake');
        
        spawnParticles(e.clientX, e.clientY, '#38bdf8');
        spawnText(e.clientX, e.clientY - 40, `+${Math.floor(gain)}`, '#fff');
        if(state.exp > state.lvl * 1500) { state.exp = 0; state.lvl++; }
        updateUI();
    };

    // --- CARDS ---
    async function startCardGame() {
        if(state.money < 1) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!");
        state.money -= 1;
        updateUI();
        
        const overlay = document.getElementById('card-overlay');
        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        overlay.style.display = 'flex';

        for(let i=0; i<3; i++) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="card-front">‚ùì</div><div class="card-back"><img src="" id="img-${i}"></div>`;
            card.onclick = () => revealCard(i);
            container.appendChild(card);
        }
    }

   async function revealCard(selectedIndex) {
    const cards = document.querySelectorAll('.card');
    if(cards[selectedIndex].classList.contains('flipped')) return;

    try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º JSON —Å –ø—É—Ç–µ–º –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ
        const response = await fetch('/get-random-present');
        const data = await response.json();
        
        if (!data.path) {
            throw new Error(data.error || "–ü–æ–¥–∞—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç—å –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ –∏–∑ JSON
        const img = document.getElementById(`img-${selectedIndex}`);
        img.src = data.path;
        
        cards[selectedIndex].classList.add('flipped');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –≤ –≥–∞–ª–µ—Ä–µ—é
        state.gallery.push(data.path);
        save();

        // –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç
        setTimeout(() => {
            cards.forEach((c, idx) => {
                if(idx !== selectedIndex) c.classList.add('fail');
            });
            setTimeout(() => {
                document.getElementById('card-overlay').style.display = 'none';
            }, 1000);
        }, 1500);

    } catch(e) {
        console.error("–û—à–∏–±–∫–∞:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: \n1. –ü–∞–ø–∫–∞ 'presents' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.\n2. –í –ø–∞–ø–∫–µ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n3. –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.");
        document.getElementById('card-overlay').style.display = 'none';
    }
}

    // --- LOOP & FX ---
    function spawnParticles(x, y, color) { for(let i=0; i<10; i++) particles.push({ x, y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 1, color, size: 3 }); }
    function spawnText(x, y, txt, col) { particles.push({ x, y, vy: -2, life: 1, text: txt, color: col, isText: true }); }

    function loop() {
        fctx.clearRect(0,0,innerWidth,innerHeight);
        tctx.clearRect(0,0,innerWidth,innerHeight);
        sctx.clearRect(0,0,innerWidth,innerHeight);

        sctx.fillStyle = "white";
        snowflakes.forEach(p => {
            p.y += p.v; if(p.y > innerHeight) p.y = -10;
            sctx.beginPath(); sctx.arc(p.x, p.y, p.r, 0, Math.PI*2); sctx.fill();
        });

        if(tracerPoints.length > 1) {
            tctx.shadowBlur = 15; tctx.shadowColor = "#38bdf8";
            tctx.strokeStyle = "rgba(56, 189, 248, 0.6)"; tctx.lineWidth = 4; tctx.lineCap = "round";
            tctx.beginPath(); tctx.moveTo(tracerPoints[0].x, tracerPoints[0].y);
            for(let i=1; i<tracerPoints.length; i++) tctx.lineTo(tracerPoints[i].x, tracerPoints[i].y);
            tctx.stroke();
            if(tracerPoints.length > 15) tracerPoints.shift();
        }

        particles.forEach((p, i) => {
            p.x += (p.vx || 0); p.y += p.vy; p.life -= 0.02;
            fctx.globalAlpha = p.life;
            if(p.isText) { fctx.fillStyle = p.color; fctx.font = "800 28px 'Plus Jakarta Sans'"; fctx.fillText(p.text, p.x, p.y); }
            else { fctx.fillStyle = p.color; fctx.beginPath(); fctx.arc(p.x, p.y, p.size, 0, Math.PI*2); fctx.fill(); }
            if(p.life <= 0) particles.splice(i,1);
        });

        const s = getStats();
        if(s.auto > 0) { state.money += (s.auto * s.mult)/60; updateUI(); }
        requestAnimationFrame(loop);
    }

    function updateUI() {
        const s = getStats();
        document.getElementById('money-txt').innerText = Math.floor(state.money).toLocaleString();
        document.getElementById('lvl-txt').innerText = state.lvl;
        document.getElementById('mult-txt').innerText = `x${s.mult.toFixed(0)}`;
        save();
    }

    function toggleTree(v) { document.getElementById('tree-overlay').style.display = v?'block':'none'; if(v) renderTree(); }
    function toggleGallery(v) {
        document.getElementById('gallery-overlay').style.display = v?'block':'none';
        if(v) document.getElementById('gallery-grid').innerHTML = state.gallery.map(url => `<div class="gallery-item"><img src="${url}"></div>`).join('');
    }

    function renderTree() {
        const area = document.getElementById('tree-area');
        const svg = document.getElementById('tree-lines');
        svg.innerHTML = ''; document.querySelectorAll('.node').forEach(n => n.remove());
        SKILLS.forEach(sk => {
            const unlocked = state.unlocked.includes(sk.id);
            const available = !sk.req || state.unlocked.includes(sk.req);
            if(sk.req) {
                const parent = SKILLS.find(x => x.id === sk.req);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", parent.x+"%"); line.setAttribute("y1", parent.y+"%");
                line.setAttribute("x2", sk.x+"%"); line.setAttribute("y2", sk.y+"%");
                line.setAttribute("stroke", unlocked ? "#4ade80" : "rgba(255,255,255,0.1)");
                line.setAttribute("stroke-width", "3"); svg.appendChild(line);
            }
            const n = document.createElement('div');
            n.className = `node ${unlocked ? 'unlocked' : (available ? 'available' : 'locked')}`;
            n.style.left = sk.x+"%"; n.style.top = sk.y+"%"; n.style.transform = "translate(-50%,-50%)";
            n.innerHTML = sk.icon;
            if(available && !unlocked) n.onclick = () => { if(state.money >= sk.cost) { state.money -= sk.cost; state.unlocked.push(sk.id); renderTree(); updateUI(); updateEntities(); } };
            area.appendChild(n);
        });
    }

    function updateEntities() {
        const layer = document.getElementById('entities-layer');
        state.unlocked.forEach(id => {
            const sk = SKILLS.find(x => x.id === id);
            if(sk.visual && !entities[id]) {
                const el = document.createElement('div'); el.className = 'entity'; el.innerText = sk.visual;
                el.style.left = `calc(50% + ${(Math.random()-0.5)*400}px)`; el.style.top = `calc(50% + ${(Math.random()-0.5)*400}px)`;
                layer.appendChild(el); entities[id] = el;
            }
        });
    }

    document.addEventListener('mousemove', e => {
        document.getElementById('cursor').style.left = e.clientX+'px'; document.getElementById('cursor').style.top = e.clientY+'px';
        tracerPoints.push({x: e.clientX, y: e.clientY});
        if(tracerPoints.length > 20) tracerPoints.shift();
    });

    updateUI(); updateEntities(); loop();
</script>
</body>
</html>